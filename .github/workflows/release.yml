name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build AutoRaise binary
      run: |
        make clean
        make AutoRaise
    
    - name: Build GUI app
      run: |
        make gui-app
    
    - name: Upload build log on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build/logs/build.log
        retention-days: 7
    
    - name: Create DMG
      run: |
        chmod +x create-dmg.sh
        make dmg
    
    - name: Get version
      id: get_version
      run: |
        VERSION=$(grep AUTORAISE_VERSION AutoRaise.mm | head -1 | sed 's/.*"\(.*\)".*/\1/')
        TAG="v${VERSION}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Built version: $VERSION (tag: $TAG)"
    
    - name: Check if release exists
      id: check_release
      run: |
        TAG="${{ steps.get_version.outputs.tag }}"
        REPO="${{ github.repository }}"
        
        # Check if release exists using GitHub API
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Release for tag $TAG already exists, skipping creation"
        elif [ "$HTTP_CODE" = "404" ]; then
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Release for tag $TAG does not exist, will create it"
        else
          echo "Unexpected HTTP code: $HTTP_CODE when checking for release"
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Will attempt to create release (may fail if it already exists)"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create tag if it doesn't exist
      if: steps.check_release.outputs.exists == 'false'
      run: |
        TAG="${{ steps.get_version.outputs.tag }}"
        REPO="${{ github.repository }}"
        
        # Check if tag exists
        TAG_EXISTS=$(git ls-remote --tags origin "refs/tags/${TAG}" 2>/dev/null | wc -l)
        if [ "$TAG_EXISTS" -eq 0 ]; then
          echo "Tag $TAG does not exist, creating it..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO}.git
          git push origin "$TAG"
          echo "Created and pushed tag $TAG"
        else
          echo "Tag $TAG already exists"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Release
      if: steps.check_release.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        files: AutoRaise.dmg
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: AutoRaise ${{ steps.get_version.outputs.version }}
        body: |
          AutoRaise ${{ steps.get_version.outputs.version }}
          
          ## Installation
          1. Download and open AutoRaise.dmg
          2. Drag AutoRaise.app to Applications
          3. Open AutoRaise.app and grant Accessibility permissions
          4. Right-click the menu bar icon to configure preferences
          
          ## Features
          - GUI launcher with menu bar icon
          - Persistent preferences
          - Option to hide menu bar icon permanently
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

